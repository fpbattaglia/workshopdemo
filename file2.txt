this is some more analysis code, with some bug fixes
